# Hotel Audit Management System - Database Documentation

## Overview
This document provides comprehensive database queries and setup instructions for the Hotel Audit Management System. The application uses PostgreSQL as the primary database with SQLAlchemy ORM for Python backend operations.

## Database Schema

### Tables Structure

#### 1. Users Table
```sql
users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL,  -- admin, auditor, reviewer, corporate, hotelgm
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

#### 2. Properties Table
```sql
properties (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    location VARCHAR(255) NOT NULL,
    region VARCHAR(255) NOT NULL,
    image VARCHAR(500),
    last_audit_score INTEGER,
    next_audit_date TIMESTAMP,
    status VARCHAR(20) DEFAULT 'green',  -- green, amber, red
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

#### 3. Audits Table
```sql
audits (
    id SERIAL PRIMARY KEY,
    property_id INTEGER NOT NULL REFERENCES properties(id),
    auditor_id INTEGER REFERENCES users(id),
    reviewer_id INTEGER REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'scheduled',  -- scheduled, in_progress, submitted, reviewed, completed
    overall_score INTEGER,
    cleanliness_score INTEGER,
    branding_score INTEGER,
    operational_score INTEGER,
    compliance_zone VARCHAR(10),  -- green, amber, red
    findings JSONB,
    action_plan JSONB,
    ai_report JSONB,  -- Generated by Gemini AI
    ai_insights JSONB,
    submitted_at TIMESTAMP,
    reviewed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

#### 4. Audit Items Table
```sql
audit_items (
    id SERIAL PRIMARY KEY,
    audit_id INTEGER NOT NULL REFERENCES audits(id),
    category VARCHAR(255) NOT NULL,
    item VARCHAR(255) NOT NULL,
    score INTEGER,
    comments TEXT,
    photos JSONB,
    ai_analysis JSONB,
    ai_suggested_score INTEGER,
    status VARCHAR(20) DEFAULT 'pending',  -- pending, completed
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

## Quick Setup Commands

### 1. Database Creation
```bash
# Create PostgreSQL user and database
sudo -u postgres psql -c "CREATE USER hotelaudit WITH PASSWORD 'password123';"
sudo -u postgres psql -c "CREATE DATABASE hotel_audit OWNER hotelaudit;"
```

### 2. Python Environment Setup
```bash
# Install dependencies
pip install -r requirements.txt

# Initialize database with Python
cd python_backend && python init_db.py
```

### 3. Run SQL Schema (Alternative)
```bash
# If running SQL directly
psql -U hotelaudit -d hotel_audit -f database_queries.sql
```

## Most Common Queries

### Authentication & User Management
```sql
-- Login authentication
SELECT id, username, password, role, name, email 
FROM users WHERE username = 'admin';

-- Get users by role
SELECT * FROM users WHERE role = 'auditor' ORDER BY name;
```

### Property Operations
```sql
-- Get all properties with latest audit info
SELECT p.*, a.overall_score as latest_score, a.compliance_zone 
FROM properties p 
LEFT JOIN audits a ON p.id = a.property_id 
    AND a.id = (SELECT MAX(id) FROM audits WHERE property_id = p.id)
ORDER BY p.name;

-- Properties needing audits
SELECT * FROM properties 
WHERE next_audit_date IS NULL OR next_audit_date < CURRENT_DATE;
```

### Audit Management
```sql
-- Get audits with full details
SELECT a.*, p.name as property_name, au.name as auditor_name, r.name as reviewer_name
FROM audits a
JOIN properties p ON a.property_id = p.id
LEFT JOIN users au ON a.auditor_id = au.id
LEFT JOIN users r ON a.reviewer_id = r.id
ORDER BY a.created_at DESC;

-- Update audit scores
UPDATE audits SET 
    overall_score = 85,
    compliance_zone = 'green',
    status = 'submitted',
    submitted_at = CURRENT_TIMESTAMP
WHERE id = 1;
```

### Compliance Reporting
```sql
-- Compliance dashboard
SELECT 
    COUNT(DISTINCT p.id) as total_properties,
    AVG(a.overall_score) as avg_score,
    COUNT(CASE WHEN a.compliance_zone = 'green' THEN 1 END) as green_audits,
    COUNT(CASE WHEN a.compliance_zone = 'amber' THEN 1 END) as amber_audits,
    COUNT(CASE WHEN a.compliance_zone = 'red' THEN 1 END) as red_audits
FROM properties p
LEFT JOIN audits a ON p.id = a.property_id
WHERE a.status = 'completed';
```

### AI Integration
```sql
-- Update with AI report
UPDATE audits SET 
    ai_report = '{"summary": "AI analysis complete", "recommendations": [...]}',
    ai_insights = '{"patterns": [...], "predictions": [...]}'
WHERE id = 1;

-- AI score accuracy
SELECT category, item, ai_suggested_score, score as actual_score,
       ABS(ai_suggested_score - score) as difference
FROM audit_items 
WHERE ai_suggested_score IS NOT NULL AND score IS NOT NULL
ORDER BY difference DESC;
```

## Performance Optimization

### Essential Indexes
```sql
-- User indexes
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);

-- Property indexes
CREATE INDEX idx_properties_region ON properties(region);
CREATE INDEX idx_properties_status ON properties(status);

-- Audit indexes
CREATE INDEX idx_audits_property_id ON audits(property_id);
CREATE INDEX idx_audits_auditor_id ON audits(auditor_id);
CREATE INDEX idx_audits_status ON audits(status);
CREATE INDEX idx_audits_created_at ON audits(created_at);

-- Audit item indexes
CREATE INDEX idx_audit_items_audit_id ON audit_items(audit_id);
CREATE INDEX idx_audit_items_category ON audit_items(category);
```

### Useful Views
```sql
-- Audit summary view
CREATE VIEW audit_summary AS
SELECT 
    a.id, a.status, a.overall_score, a.compliance_zone,
    p.name as property_name, p.location,
    au.name as auditor_name, r.name as reviewer_name,
    COUNT(ai.id) as total_items,
    AVG(ai.score) as avg_item_score
FROM audits a
JOIN properties p ON a.property_id = p.id
LEFT JOIN users au ON a.auditor_id = au.id
LEFT JOIN users r ON a.reviewer_id = r.id
LEFT JOIN audit_items ai ON a.id = ai.audit_id
GROUP BY a.id, p.name, p.location, au.name, r.name;
```

## Data Analytics Queries

### Property Performance
```sql
-- Regional performance
SELECT region, COUNT(*) as properties, AVG(last_audit_score) as avg_score
FROM properties GROUP BY region ORDER BY avg_score DESC;

-- Property improvement tracking
WITH property_scores AS (
    SELECT property_id, overall_score, created_at,
           LAG(overall_score) OVER (PARTITION BY property_id ORDER BY created_at) as prev_score
    FROM audits WHERE overall_score IS NOT NULL
)
SELECT p.name, ps.overall_score, ps.prev_score, 
       ps.overall_score - ps.prev_score as improvement
FROM property_scores ps
JOIN properties p ON ps.property_id = p.id
WHERE ps.prev_score IS NOT NULL
ORDER BY improvement DESC;
```

### Auditor Analytics
```sql
-- Auditor performance
SELECT u.name, COUNT(a.id) as total_audits, AVG(a.overall_score) as avg_score,
       AVG(EXTRACT(days FROM a.submitted_at - a.created_at)) as avg_days
FROM users u
LEFT JOIN audits a ON u.id = a.auditor_id
WHERE u.role = 'auditor'
GROUP BY u.id, u.name
ORDER BY total_audits DESC;
```

### Trend Analysis
```sql
-- Monthly audit trends
SELECT DATE_TRUNC('month', created_at) as month,
       COUNT(*) as total_audits,
       AVG(overall_score) as avg_score
FROM audits
WHERE created_at >= CURRENT_DATE - INTERVAL '12 months'
GROUP BY DATE_TRUNC('month', created_at)
ORDER BY month;
```

## Maintenance Tasks

### Regular Cleanup
```sql
-- Archive old data (3+ years)
DELETE FROM audit_items WHERE audit_id IN (
    SELECT id FROM audits WHERE created_at < CURRENT_DATE - INTERVAL '3 years'
);
DELETE FROM audits WHERE created_at < CURRENT_DATE - INTERVAL '3 years';

-- Update audit schedules
UPDATE properties SET next_audit_date = CURRENT_DATE + INTERVAL '3 months'
WHERE next_audit_date < CURRENT_DATE;
```

### Database Maintenance
```sql
-- Update statistics
ANALYZE users;
ANALYZE properties;
ANALYZE audits;
ANALYZE audit_items;

-- Check for orphaned records
SELECT 'Orphaned audit items' as issue, COUNT(*) 
FROM audit_items ai LEFT JOIN audits a ON ai.audit_id = a.id 
WHERE a.id IS NULL;
```

## Security Considerations

### User Permissions
```sql
-- Create read-only user for reporting
CREATE USER audit_reader WITH PASSWORD 'readonly_password';
GRANT SELECT ON ALL TABLES IN SCHEMA public TO audit_reader;

-- Create limited auditor user
CREATE USER auditor_app WITH PASSWORD 'auditor_password';
GRANT SELECT, INSERT, UPDATE ON audits, audit_items TO auditor_app;
GRANT SELECT ON properties, users TO auditor_app;
```

### Data Encryption
- All passwords are hashed using bcrypt
- Sensitive data in JSONB fields should be encrypted at application level
- Use SSL connections for production database access

## Backup Strategy

### Regular Backups
```bash
# Daily backup
pg_dump -U hotelaudit -h localhost hotel_audit > backup_$(date +%Y%m%d).sql

# Backup with compression
pg_dump -U hotelaudit -h localhost hotel_audit | gzip > backup_$(date +%Y%m%d).sql.gz
```

### Restore Process
```bash
# Restore from backup
psql -U hotelaudit -h localhost hotel_audit < backup_20250722.sql
```

## API Integration Points

The database queries are integrated with the FastAPI backend through:

1. **SQLAlchemy ORM Models** (`app/models/models.py`)
2. **Database Query Class** (`database_queries.py`)
3. **API Endpoints** (`app/api/endpoints/`)
4. **Pydantic Schemas** (`app/schemas/schemas.py`)

### Example Usage in API
```python
from database_queries import DatabaseQueries

@router.get("/properties/")
async def get_properties(db: Session = Depends(get_db)):
    queries = DatabaseQueries(db)
    return queries.get_all_properties()
```

## Monitoring & Alerts

### Performance Monitoring
```sql
-- Slow query identification
SELECT query, mean_time, calls, total_time 
FROM pg_stat_statements 
ORDER BY mean_time DESC LIMIT 10;

-- Connection monitoring
SELECT count(*), state FROM pg_stat_activity GROUP BY state;
```

### Health Checks
```sql
-- Database health check
SELECT 
    pg_database_size('hotel_audit') as db_size,
    (SELECT count(*) FROM users) as total_users,
    (SELECT count(*) FROM properties) as total_properties,
    (SELECT count(*) FROM audits) as total_audits;
```

This comprehensive database documentation provides all the necessary queries and setup instructions for the Hotel Audit Management System.
